-- Analysis of Air Quality Data using Serverless SQL
-- This query reads raw CSV data from Azure Data Lake Gen2 without ETL

SELECT
    Country,
    COUNT(*) as records_count,
    AVG([AQI Value]) as average_pollution
FROM
    OPENROWSET(
        BULK 'https://studentdatalake2024.dfs.core.windows.net/raw-data/air_quality.csv.csv',
        FORMAT = 'CSV',
        PARSER_VERSION = '2.0',
        HEADER_ROW = TRUE
    )
    WITH (
        Country VARCHAR(100) COLLATE Latin1_General_100_CI_AS_SC_UTF8,
        [AQI Value] FLOAT
    ) AS [result]
WHERE
    [AQI Value] > 50
GROUP BY
    Country
ORDER BY
    average_pollution DESC;